# shellcheck shell=bash

# Worktree-specific Beads setup:
# https://github.com/steveyegge/beads/blob/main/docs/ADVANCED.md#git-worktrees
_git_dir="$(git rev-parse --git-dir 2>/dev/null || true)"
_git_common_dir="$(git rev-parse --git-common-dir 2>/dev/null || true)"
if [ -n "$_git_dir" ] && [ -n "$_git_common_dir" ] && [ "$_git_dir" != "$_git_common_dir" ]; then
  # Linked worktree: force shared Beads store.
  export BEADS_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/beads/io.github/bdelanghe/lone/.beads"

  # Daemon behavior in worktrees:
  # - If sync-branch is configured, daemon is safe to use.
  # - If sync-branch is not configured, force direct mode.
  # Ref:
  # https://github.com/steveyegge/beads/blob/main/docs/DAEMON.md#git-worktrees-and-daemon
  _sync_branch=""
  if [ -f "${BEADS_DIR}/config.yaml" ]; then
    _sync_branch="$(
      awk -F': ' '/^sync-branch:/ {gsub(/"/, "", $2); print $2; exit}' "${BEADS_DIR}/config.yaml"
    )"
  fi
  if [ -z "$_sync_branch" ]; then
    export BEADS_NO_DAEMON="${BEADS_NO_DAEMON:-1}"
  fi
  unset _sync_branch
fi
unset _git_dir _git_common_dir

# Add scripts to PATH for canonical test command
export PATH="$PWD/scripts:$HOME/.npm-global/bin:$PATH"
export BDUI_URL="http://127.0.0.1:3000"
