# shellcheck shell=bash

# Worktree-specific Beads setup:
# https://github.com/steveyegge/beads/blob/main/docs/ADVANCED.md#git-worktrees
_git_dir="$(git rev-parse --git-dir 2>/dev/null || true)"
_git_common_dir="$(git rev-parse --git-common-dir 2>/dev/null || true)"
if [ -n "$_git_dir" ] && [ -n "$_git_common_dir" ] && [ "$_git_dir" != "$_git_common_dir" ]; then
  # Linked git worktree detected.
  export BD_IN_GIT_WORKTREE=1

  # Linked worktree: use shared Beads store when present.
  # If missing, fall back to main worktree .beads; otherwise use auto-discovery.
  _shared_beads="${XDG_DATA_HOME:-$HOME/.local/share}/beads/io.github/bdelanghe/lone/.beads"
  _main_worktree="$(
    git worktree list --porcelain \
      | awk '$1 == "worktree" { wt = $2 } $1 == "branch" && $2 == "refs/heads/main" { print wt; exit }'
  )"
  _main_beads=""
  if [ -n "$_main_worktree" ]; then
    _main_beads="${_main_worktree}/.beads"
  fi
  if [ -d "$_shared_beads" ]; then
    export BEADS_DIR="$_shared_beads"
  elif [ -n "$_main_beads" ] && [ -d "$_main_beads" ]; then
    export BEADS_DIR="$_main_beads"
  fi

  # In linked worktrees, force direct mode to avoid daemon branch confusion.
  export BEADS_NO_DAEMON="${BEADS_NO_DAEMON:-1}"

  unset _shared_beads _main_worktree _main_beads
else
  export BD_IN_GIT_WORKTREE=0
fi

# Resolve absolute path to git common dir for compose volume mounts (worktree support)
export BARE_REPO
BARE_REPO="$(cd "${_git_common_dir:-.git}" && pwd -P 2>/dev/null || echo "${PWD}/.git")"

unset _git_dir _git_common_dir

# Ensure BEADS_DIR is always set for compose (fallback to XDG path)
: "${BEADS_DIR:=${XDG_DATA_HOME:-${HOME}/.local/share}/beads/io.github/bdelanghe/lone/.beads}"
export BEADS_DIR

# Host gh config dir to mount into the devcontainer.
: "${GH_CONFIG_DIR:=${XDG_CONFIG_HOME:-${HOME}/.config}/gh}"
export GH_CONFIG_DIR

# Git identity for container commits (only set if not already set)
if [ -z "${GIT_AUTHOR_NAME:-}" ]; then
  _n="$(git config --global --get user.name 2>/dev/null || true)"
  [ -n "$_n" ] && export GIT_AUTHOR_NAME="$_n"
fi

if [ -z "${GIT_AUTHOR_EMAIL:-}" ]; then
  _e="$(git config --global --get user.email 2>/dev/null || true)"
  [ -n "$_e" ] && export GIT_AUTHOR_EMAIL="$_e"
fi

# SSH agent socket to mount into the devcontainer.
#
# macOS note: Docker Desktop cannot reliably bind-mount the user's SSH_AUTH_SOCK
# (a host unix socket) into Linux containers. Use Docker Desktop's special
# host-services socket by default.
if [ -z "${DEVCONTAINER_SSH_AUTH_SOCK:-}" ]; then
  if [ "$(uname -s)" = "Darwin" ]; then
    DEVCONTAINER_SSH_AUTH_SOCK=/run/host-services/ssh-auth.sock
  else
    DEVCONTAINER_SSH_AUTH_SOCK=${SSH_AUTH_SOCK:-/run/host-services/ssh-auth.sock}
  fi
fi
export DEVCONTAINER_SSH_AUTH_SOCK

unset _n _e

# Generate .env for docker compose/devcontainer.
#
# This repo treats .env as a cache/bridge for tooling that reads envfiles.
# direnv remains the source of truth and rewrites .env deterministically.
__dotenv_quote() {
  local s="$1"
  s="${s//\\/\\\\}"
  s="${s//\"/\\\"}"
  printf '"%s"' "$s"
}

__write_envfile() {
  local tmp
  tmp="$(mktemp)"

  {
    echo "# Generated by direnv (.envrc). DO NOT EDIT."
    echo "BARE_REPO=$(__dotenv_quote "${BARE_REPO:-}")"
    echo "BEADS_DIR=$(__dotenv_quote "${BEADS_DIR:-}")"
    echo "GIT_AUTHOR_NAME=$(__dotenv_quote "${GIT_AUTHOR_NAME:-}")"
    echo "GIT_AUTHOR_EMAIL=$(__dotenv_quote "${GIT_AUTHOR_EMAIL:-}")"
    echo "DEVCONTAINER_SSH_AUTH_SOCK=$(__dotenv_quote "${DEVCONTAINER_SSH_AUTH_SOCK:-}")"
    echo "GH_CONFIG_DIR=$(__dotenv_quote "${GH_CONFIG_DIR:-}")"
  } >"$tmp"

  if [ -f .env ] && cmp -s "$tmp" .env; then
    rm -f "$tmp"
  else
    mv -f "$tmp" .env
  fi
}

__write_envfile
unset -f __dotenv_quote __write_envfile

# Load the generated envfile at the end so the shell environment matches compose.
dotenv .env

# Add scripts to PATH for canonical test command
export PATH="$PWD/scripts:$HOME/.npm-global/bin:$PATH"
export BDUI_URL="http://127.0.0.1:3000"

# Provide deno via docker runner when not available locally.
if ! command -v deno >/dev/null 2>&1; then
  deno() {
    docker compose run --rm dev deno "$@"
  }
fi
