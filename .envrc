# shellcheck shell=bash

# Worktree-specific Beads setup:
# https://github.com/steveyegge/beads/blob/main/docs/ADVANCED.md#git-worktrees
_git_dir="$(git rev-parse --git-dir 2>/dev/null || true)"
_git_common_dir="$(git rev-parse --git-common-dir 2>/dev/null || true)"
if [ -n "$_git_dir" ] && [ -n "$_git_common_dir" ] && [ "$_git_dir" != "$_git_common_dir" ]; then
  # Linked git worktree detected.
  export BD_IN_GIT_WORKTREE=1

  # Linked worktree: use shared Beads store when present.
  # If missing, fall back to main worktree .beads; otherwise use auto-discovery.
  _shared_beads="${XDG_DATA_HOME:-$HOME/.local/share}/beads/io.github/bdelanghe/lone/.beads"
  _main_worktree="$(
    git worktree list --porcelain \
      | awk '$1 == "worktree" { wt = $2 } $1 == "branch" && $2 == "refs/heads/main" { print wt; exit }'
  )"
  _main_beads=""
  if [ -n "$_main_worktree" ]; then
    _main_beads="${_main_worktree}/.beads"
  fi
  if [ -d "$_shared_beads" ]; then
    export BEADS_DIR="$_shared_beads"
  elif [ -n "$_main_beads" ] && [ -d "$_main_beads" ]; then
    export BEADS_DIR="$_main_beads"
  fi

  # In linked worktrees, force direct mode to avoid daemon branch confusion.
  export BEADS_NO_DAEMON="${BEADS_NO_DAEMON:-1}"

  unset _shared_beads _main_worktree _main_beads
else
  export BD_IN_GIT_WORKTREE=0
fi

# Resolve absolute path to git common dir for compose volume mounts (worktree support)
export BARE_REPO
BARE_REPO="$(cd "${_git_common_dir:-.git}" && pwd -P 2>/dev/null || echo "${PWD}/.git")"

unset _git_dir _git_common_dir

# Ensure BEADS_DIR is always set for compose (fallback to XDG path)
: "${BEADS_DIR:=${XDG_DATA_HOME:-${HOME}/.local/share}/beads/io.github/bdelanghe/lone/.beads}"
export BEADS_DIR

# Add scripts to PATH for canonical test command
export PATH="$PWD/scripts:$HOME/.npm-global/bin:$PATH"
export BDUI_URL="http://127.0.0.1:3000"

# Provide deno via docker runner when not available locally.
if ! command -v deno >/dev/null 2>&1; then
  deno() {
    docker compose run --rm dev deno "$@"
  }
fi
