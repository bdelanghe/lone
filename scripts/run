#!/usr/bin/env bash
set -euo pipefail

IMAGE="semantic-test"
WORKDIR="/workspace"

# Run arbitrary command in container
# Usage: ./scripts/run <command> [args...]
# Examples:
#   ./scripts/run deno fmt --check
#   ./scripts/run deno lint
#   ./scripts/run deno test

# Already inside the container â€” run directly
if [ "${IN_DEV_CONTAINER:-}" = "1" ]; then
  exec "$@"
fi

mkdir -p .xdg/cache

docker run --rm \
  -v "$(pwd):${WORKDIR}" -w "${WORKDIR}" \
  -v "$(pwd)/.xdg/cache:/xdg/cache" \
  -e IN_DEV_CONTAINER=1 \
  -e XDG_CACHE_HOME=/xdg/cache \
  -e DENO_DIR=/xdg/cache/deno \
  -e NPM_CONFIG_CACHE=/xdg/cache/npm \
  "${IMAGE}" \
  bash -lc "$*"
