services:
  dev:
    image: semantic-test
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile
    working_dir: /workspace
    stdin_open: true
    tty: true
    volumes:
      - .:/workspace
      # Forward host SSH agent for git auth.
      #
      # This is populated by .envrc -> .env generation. Defaults to Docker Desktop's
      # /run/host-services/ssh-auth.sock when no host SSH_AUTH_SOCK is present.
      - ${DEVCONTAINER_SSH_AUTH_SOCK:-/run/host-services/ssh-auth.sock}:/ssh-agent:ro
      # Mount host gh config (contains auth) into a staging directory.
      # The postStartCommand copies it into the container home so permissions are sane.
      - ${GH_CONFIG_DIR:?Set GH_CONFIG_DIR (e.g. in .env)}:/mnt/gh-config:ro
      # Needed for git worktrees: the .git file inside the worktree points to this host path.
      - ${BARE_REPO:?Set BARE_REPO (e.g. in .env)}:${BARE_REPO:?Set BARE_REPO (e.g. in .env)}
      # Persist Claude Code state (including any ~/.claude.json it creates) inside a named volume.
      # Avoids host bind-mounts and prevents macOS-only absolute symlinks from breaking in Linux.
      - vscode-home:/home/vscode
      - ${BEADS_DIR:?Set BEADS_DIR (e.g. in .env)}:/beads
    ports:
      - "3000:3000"
    environment:
      - IN_DEV_CONTAINER=1
      - XDG_CACHE_HOME=/home/vscode/.cache
      - DENO_DIR=/home/vscode/.cache/deno
      - NPM_CONFIG_CACHE=/home/vscode/.cache/npm
      # SSH agent socket forwarded via /ssh-agent volume mount.
      - SSH_AUTH_SOCK=/ssh-agent
      # Do not pass ANTHROPIC_API_KEY by default; Claude warns when both it and a claude.ai token are present.
      - BEADS_DIR=/beads
      # beads-ui (bdui) prefers BEADS_DB for selecting the SQLite DB.
      - BEADS_DB=/beads/beads.db
      # Git identity (used for commits inside the container)
      - GIT_AUTHOR_NAME=${GIT_AUTHOR_NAME:-}
      - GIT_AUTHOR_EMAIL=${GIT_AUTHOR_EMAIL:-}
      - GIT_COMMITTER_NAME=${GIT_AUTHOR_NAME:-}
      - GIT_COMMITTER_EMAIL=${GIT_AUTHOR_EMAIL:-}

volumes:
  vscode-home: {}
